<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>test</title>
    <style>
        /* チェックボックスを横並びにするスタイル */
        .checkbox-container {
            display: flex;
            gap: 10px;  /* チェックボックスの間にスペースを追加 */
        }
        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        .remove-btn {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
    </style>
    <!-- select2のCSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
</head>
<body>

<!-- チェックボックスを横並びに配置 -->
<div class="checkbox-container">
    <label>
        <input type="checkbox" class="group-checkbox" data-group="operational-data" checked> Operational Data
    </label>
    <label>
        <input type="checkbox" class="group-checkbox" data-group="abnormal-data" checked> Abnormal Data
    </label>
    <label>
        <input type="checkbox" class="group-checkbox" data-group="warning-data" checked> Warning Data
    </label>
    <label>
        <input type="checkbox" class="group-checkbox" data-group="batch-data" checked> Batch Data
    </label>
</div>

<br><br>

<!-- テーブル -->
<table id="dynamicTable">
    <thead>
        <tr>
            <th>Select Box</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        <!-- 動的に追加される行 -->
    </tbody>
</table>

<!-- ボタン -->
<button id="addRowBtn">Add Row</button>

<!-- jQueryとselect2のJS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tableBody = document.querySelector('#dynamicTable tbody');
    const addRowBtn = document.getElementById('addRowBtn');

    // カテゴリー名を定義
    const initialOptions = [
        { value: 'option1-1', text: 'Operational Option 1', className: 'operational-data' },
        { value: 'option1-2', text: 'Operational Option 2', className: 'operational-data' },
        { value: 'option2-1', text: 'Abnormal Option 1', className: 'abnormal-data' },
        { value: 'option2-2', text: 'Abnormal Option 2', className: 'abnormal-data' },
        { value: 'option3-1', text: 'Warning Option 1', className: 'warning-data' },
        { value: 'option3-2', text: 'Warning Option 2', className: 'warning-data' },
        { value: 'option4-1', text: 'Batch Option 1', className: 'batch-data' },
        { value: 'option4-2', text: 'Batch Option 2', className: 'batch-data' }
    ];

    // チェックボックスの状態を取得する関数
    function getActiveGroups() {
        const checkboxes = document.querySelectorAll('.group-checkbox');
        return Array.from(checkboxes).filter(checkbox => checkbox.checked).map(checkbox => checkbox.dataset.group);
    }

    // 新しい行をテーブルに追加する関数
    function addRow() {
        const activeGroups = getActiveGroups();
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td>
                <select class="variable-box" size="10" multiple>
                    ${generateOptions(activeGroups)}
                </select>
            </td>
            <td>
                <button class="remove-btn">Remove</button>
            </td>
        `;
        tableBody.appendChild(newRow);

        // select2の適用
        $(newRow).find('.variable-box').select2({
            dropdownAutoWidth: true,
            width: '100%',
            minimumResultsForSearch: -1
        });

        // 削除ボタンにイベントを追加
        newRow.querySelector('.remove-btn').addEventListener('click', function() {
            removeRow(this);
        });
    }

    // オプションを生成する関数
    function generateOptions(activeGroups) {
        return initialOptions
            .filter(option => activeGroups.includes(option.className))
            .map(option => `<option class="${option.className}" value="${option.value}">${option.text}</option>`)
            .join('');
    }

    // 行を削除する関数
    function removeRow(button) {
        if (tableBody.rows.length > 1) {
            button.closest('tr').remove();
        } else {
            alert("This is the last row and cannot be removed.");
        }
    }

    // チェックボックスの状態に応じて全てのセレクトボックスのオプションを更新する関数
    function updateAllSelectBoxes() {
        const activeGroups = getActiveGroups();
        document.querySelectorAll('.variable-box').forEach(selectBox => {
            const selectElement = $(selectBox);
            selectElement.empty(); // 既存のオプションをクリア
            const optionsHTML = generateOptions(activeGroups);
            selectElement.append(optionsHTML);

            // select2を再初期化
            selectElement.select2({
                dropdownAutoWidth: true,
                width: '100%',
                minimumResultsForSearch: -1
            });
        });
    }

    // 初期状態で1行追加
    addRow();

    // 新しい行を追加するボタンのクリックイベント
    addRowBtn.addEventListener('click', addRow);

    // チェックボックスの変更イベント
    document.querySelector('.checkbox-container').addEventListener('change', updateAllSelectBoxes);
});
</script>

</body>
</html>
